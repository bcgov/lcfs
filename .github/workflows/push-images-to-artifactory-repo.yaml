name: Push Dependent Images to Artifactory

on:
  push:
    branches:
      - devops/artifactory
  workflow_dispatch:

env:
  ARTIFACTORY_REGISTRY: ${{ secrets.ARTIFACTORY_REGISTRY }}
  ARTIFACTORY_REPO: ${{ secrets.ARTIFACTORY_REPO }}
  ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
  ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
  ARTIFACTORY_TOKEN: ${{ secrets.ARTIFACTORY_TOKEN }}
  ARTIFACTORY_API_KEY: ${{ secrets.ARTIFACTORY_API_KEY }}
  METABASE_IMAGE_TAG: v0.52.6.x
  CLAMAV_IMAGE_TAG: 1.4.3_base
  DANDYREDIS_REDIS_IMAGE_TAG: 8.2.2-alpine
  DANDYREDIS_HAPROXY_IMAGE_TAG: 3.0.8-alpine
  SHELLCHECK_IMAGE_TAG: v0.10.0
  PROD_NAMESPACE: ${{ secrets.OPENSHIFT_NAMESPACE_PLATE }}-prod

jobs:
  install-oc:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4.1.1

      - name: Set up cache for OpenShift CLI
        id: cache
        uses: actions/cache@v4.2.0
        with:
          path: /usr/local/bin/oc # Path where the `oc` binary will be installed
          key: oc-cli-${{ runner.os }}

      - name: Install OpenShift CLI (if not cached)
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          curl -LO https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz
          tar -xvf openshift-client-linux.tar.gz
          sudo mv oc /usr/local/bin/
          oc version --client

      - name: Confirm OpenShift CLI is Available
        run: oc version --client

  push-metabase-to-artifactory:
    name: Push Metabase image to Artifactory
    needs: [install-oc]
    runs-on: ubuntu-latest
    steps:
      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to Artifactory
        run: |
          set -euo pipefail
          AUTH_CURL_FLAGS=()
          AUTH_PASSWORD=""
          if [ -n "${ARTIFACTORY_TOKEN:-}" ]; then
            AUTH_CURL_FLAGS=(-H "Authorization: Bearer ${ARTIFACTORY_TOKEN}")
            AUTH_PASSWORD="${ARTIFACTORY_TOKEN}"
          elif [ -n "${ARTIFACTORY_API_KEY:-}" ]; then
            AUTH_CURL_FLAGS=(-H "X-JFrog-Art-Api: ${ARTIFACTORY_API_KEY}")
            AUTH_PASSWORD="${ARTIFACTORY_API_KEY}"
          else
            AUTH_CURL_FLAGS=(-u "${ARTIFACTORY_USERNAME}:${ARTIFACTORY_PASSWORD}")
            AUTH_PASSWORD="${ARTIFACTORY_PASSWORD}"
          fi
          curl -fsS "${AUTH_CURL_FLAGS[@]}" \
            "https://${ARTIFACTORY_REGISTRY}/artifactory/api/system/ping"
          REPO_INFO="$(curl -fsS "${AUTH_CURL_FLAGS[@]}" \
            "https://${ARTIFACTORY_REGISTRY}/artifactory/api/repositories/${ARTIFACTORY_REPO}")"
          echo "${REPO_INFO}" | tr -d '\n' | grep -Eq '"packageType"[[:space:]]*:[[:space:]]*"docker"' || \
            { echo "Repo ${ARTIFACTORY_REPO} is not a Docker repo."; exit 1; }
          echo "${REPO_INFO}" | tr -d '\n' | grep -Eq '"rclass"[[:space:]]*:[[:space:]]*"(local|virtual|federated)"' || \
            { echo "Repo ${ARTIFACTORY_REPO} must be local or virtual or federated."; exit 1; }
          skopeo login --authfile /tmp/artifactory-auth.json \
            --username "${ARTIFACTORY_USERNAME}" \
            --password "${AUTH_PASSWORD}" \
            "${ARTIFACTORY_REGISTRY}"

      - name: Restore oc command from Cache
        uses: actions/cache@v4.2.0
        with:
          path: /usr/local/bin/oc
          key: oc-cli-${{ runner.os }}

      - name: Log in to Openshift
        uses: redhat-actions/oc-login@v1.3
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          insecure_skip_tls_verify: true
          namespace: ${{ env.TOOLS_NAMESPACE }}

      - name: Copy Metabase image from Docker Hub
        run: |
          set -euo pipefail
          echo "Pushing Metabase image"
          # skopeo copy --src-tls-verify=true --dest-tls-verify=true \
          #   --dest-authfile /tmp/artifactory-auth.json \
          #   "docker://metabase/metabase:${METABASE_IMAGE_TAG}" \
          #   "docker://${ARTIFACTORY_REGISTRY}/${ARTIFACTORY_REPO}/lcfs/prod/metabase/metabase:${METABASE_IMAGE_TAG}"
          # echo "Pushing Clamav image"
          # skopeo copy --src-tls-verify=true --dest-tls-verify=true \
          #   --dest-authfile /tmp/artifactory-auth.json \
          #   "docker://clamav/clamav:${CLAMAV_IMAGE_TAG}" \
          #   "docker://${ARTIFACTORY_REGISTRY}/${ARTIFACTORY_REPO}/lcfs/prod/clamav/clamav:${CLAMAV_IMAGE_TAG}"
          # echo "Pushing Dandyredis images"
          # skopeo copy --src-tls-verify=true --dest-tls-verify=true \
          #   --dest-authfile /tmp/artifactory-auth.json \
          #   "docker://public.ecr.aws/docker/library/redis:${DANDYREDIS_REDIS_IMAGE_TAG}" \
          #   "docker://${ARTIFACTORY_REGISTRY}/${ARTIFACTORY_REPO}/lcfs/prod/dandyredis/redis:${DANDYREDIS_REDIS_IMAGE_TAG}"
          # skopeo copy --src-tls-verify=true --dest-tls-verify=true \
          #   --dest-authfile /tmp/artifactory-auth.json \
          #   "docker://koalaman/shellcheck:${SHELLCHECK_IMAGE_TAG}" \
          #   "docker://${ARTIFACTORY_REGISTRY}/${ARTIFACTORY_REPO}/lcfs/prod/koalaman/shellcheck:${SHELLCHECK_IMAGE_TAG}"
          # skopeo copy --src-tls-verify=true --dest-tls-verify=true \
          #   --dest-authfile /tmp/artifactory-auth.json \
          #   "docker://public.ecr.aws/docker/library/haproxy:${DANDYREDIS_HAPROXY_IMAGE_TAG}" \
          #   "docker://${ARTIFACTORY_REGISTRY}/${ARTIFACTORY_REPO}/lcfs/prod/dandyredis/haproxy:${DANDYREDIS_HAPROXY_IMAGE_TAG}"
          REPO_BASE="docker://${ARTIFACTORY_REGISTRY}/${ARTIFACTORY_REPO}"
          REPO_PATHS=(
            "lcfs/prod/lcfs-backend"
            "lcfs/prod/lcfs-frontend"
          )
          for REPO_PATH in "${REPO_PATHS[@]}"; do
            REPO_REF="${REPO_BASE}/${REPO_PATH}"
            echo "Fetching tags for ${REPO_PATH}..."
            TAGS_JSON="$(skopeo list-tags --authfile /tmp/artifactory-auth.json "${REPO_REF}")"
            export TAGS_JSON
            TAGS="$(python3 - <<'PY'
          import json
          import os
          import sys

          raw = os.environ.get("TAGS_JSON", "")
          try:
              data = json.loads(raw)
          except json.JSONDecodeError:
              print("::error::Failed to parse tag list JSON from skopeo.", file=sys.stderr)
              sys.exit(1)

          tags = data.get("Tags")
          if not isinstance(tags, list):
              print("::error::Tag list response missing Tags array.", file=sys.stderr)
              sys.exit(1)

          print("\n".join(tag for tag in tags if tag))
          PY
          )"
                        if [ -z "${TAGS// }" ]; then
                          echo "No tags found for ${REPO_PATH}."
                        else
                          echo "Deleting tags for ${REPO_PATH}..."
                          echo "${TAGS}" | while IFS= read -r tag; do
                            [ -z "${tag}" ] && continue
                            skopeo delete --authfile /tmp/artifactory-auth.json "${REPO_REF}:${tag}"
                          done
                        fi
                      done
          # OPENSHIFT_REGISTRY="$(oc registry info --public)"
          # oc registry login --registry="${OPENSHIFT_REGISTRY}" --to=/tmp/openshift-auth.json



          # skopeo copy --src-tls-verify=false --dest-tls-verify=true \
          #   --src-authfile /tmp/openshift-auth.json --dest-authfile /tmp/artifactory-auth.json \
          #   "docker://${OPENSHIFT_REGISTRY}/${{ env.PROD_NAMESPACE }}/lcfs-backend:0.2.0-20240614165335" \
          #   "docker://${ARTIFACTORY_REGISTRY}/${ARTIFACTORY_REPO}/lcfs/prod/lcfs-backend:0.2.0-20240614165335"

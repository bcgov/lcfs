"""mv for fuel code count

Revision ID: 8119d12538df
Revises: d25e7c47659e
Create Date: 2025-01-14 23:47:28.504150

"""

import sqlalchemy as sa
from alembic import op

# revision identifiers, used by Alembic.
revision = "8119d12538df"
down_revision = "d25e7c47659e"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute(
        """
        CREATE MATERIALIZED VIEW mv_fuel_code_count AS
        SELECT 
            CASE fuel_status_id 
                WHEN 1 THEN 'Draft'
            END as status,
            COUNT(*) as count
        FROM fuel_code
        WHERE fuel_status_id = 1
        GROUP BY fuel_status_id;
        """
    )

    op.execute(
        """
        CREATE UNIQUE INDEX mv_fuel_code_count_idx 
        ON mv_fuel_code_count (status);
        """
    )

    op.execute(
        """
        CREATE OR REPLACE FUNCTION refresh_mv_fuel_code_count()
        RETURNS TRIGGER AS $$
        BEGIN
            REFRESH MATERIALIZED VIEW CONCURRENTLY mv_fuel_code_count;
            RETURN NULL;
        END;
        $$ LANGUAGE plpgsql;
        """
    )

    op.execute(
        """
        CREATE TRIGGER refresh_mv_fuel_code_count_after_change
        AFTER INSERT OR UPDATE OR DELETE ON fuel_code
        FOR EACH STATEMENT EXECUTE FUNCTION refresh_mv_fuel_code_count();
        """
    )

    # Refresh the materialized view to include existing fuel codes
    op.execute(
        "REFRESH MATERIALIZED VIEW CONCURRENTLY mv_fuel_code_count;"
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute(
        "DROP TRIGGER IF EXISTS refresh_mv_fuel_code_count_after_change ON fuel_code;")
    op.execute("DROP FUNCTION IF EXISTS refresh_mv_fuel_code_count();")
    op.execute("DROP MATERIALIZED VIEW IF EXISTS mv_fuel_code_count;")
    # ### end Alembic commands ###

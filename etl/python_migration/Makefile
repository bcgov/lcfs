# TFRS to LCFS Migration Makefile
#
# Prerequisites:
# - Docker and Docker Compose installed
# - OpenShift CLI (oc) installed
# - Python 3.8+ with requirements installed
# - User must be logged into OpenShift: oc login
#
# SECURITY NOTE: This Makefile only supports IMPORT operations.
# NO EXPORT to production databases is allowed.

.PHONY: help setup setup-prod setup-dev quick-start migrate validate check clean stop status docker-start docker-stop

# Default target
help:
	@echo "TFRS to LCFS Migration Commands"
	@echo "==============================="
	@echo ""
	@echo "ğŸš€ Quick Start:"
	@echo "  make quick-start     - Complete migration with auto Docker setup (dev data)"
	@echo "  make setup-prod      - Setup databases with PRODUCTION data (requires oc login)"
	@echo "  make setup-dev       - Setup databases with DEV data (requires oc login)"
	@echo ""
	@echo "ğŸ³ Docker Management:"
	@echo "  make docker-start    - Start TFRS container and LCFS environment"
	@echo "  make docker-stop     - Stop TFRS container"
	@echo "  make status          - Show running containers and database status"
	@echo ""
	@echo "ğŸ”§ Migration Operations:"
	@echo "  make migrate         - Run migrations only (assumes databases ready)"
	@echo "  make validate        - Run validation only (assumes migration complete)"
	@echo "  make check           - Check if databases are ready for migration"
	@echo ""
	@echo "ğŸ”„ Database Reset:"
	@echo "  make reset           - Reset LCFS database from existing .tar file"
	@echo "  make reset-lcfs      - Reset LCFS database from existing .tar file"
	@echo "  make reset-tfrs      - Reset TFRS database from existing .tar file"
	@echo "  make reset-all       - Reset both TFRS and LCFS databases"
	@echo ""
	@echo "ğŸ§¹ Cleanup:"
	@echo "  make clean           - Stop containers and clean up volumes"
	@echo "  make stop            - Stop all migration containers"
	@echo ""
	@echo "ğŸ“‹ Prerequisites:"
	@echo "  - Correct project structure: ./setup-paths.sh"
	@echo "  - Docker running"
	@echo "  - OpenShift login: oc login (for data import)"
	@echo "  - Python requirements: pip install -r requirements.txt"

# Quick start - complete migration with dev data
quick-start:
	@echo "ğŸš€ Starting complete migration with automatic setup..."
	@echo "ğŸ“‹ Using DEV environment data"
	@./quick-start.sh --env dev

# Setup databases with production data (IMPORT ONLY)
setup-prod:
	@echo "âš ï¸  Setting up databases with PRODUCTION data"
	@echo "ğŸ”’ SECURITY: Only IMPORT from production is allowed"
	@echo "ğŸ“‹ Checking OpenShift login..."
	@oc whoami || (echo "âŒ Please login to OpenShift first: oc login" && exit 1)
	@echo "ğŸ³ Starting Docker containers and importing PRODUCTION data..."
	python3 setup/migration_orchestrator.py auto-setup --env prod

# Setup databases with dev data
setup-dev:
	@echo "ğŸ”§ Setting up databases with DEV data"
	@echo "ğŸ“‹ Checking OpenShift login..."
	@oc whoami || (echo "âŒ Please login to OpenShift first: oc login" && exit 1)
	@echo "ğŸ³ Starting Docker containers and importing DEV data..."
	python3 setup/migration_orchestrator.py auto-setup --env dev

# Setup databases with test data
setup-test:
	@echo "ğŸ§ª Setting up databases with TEST data"
	@echo "ğŸ“‹ Checking OpenShift login..."
	@oc whoami || (echo "âŒ Please login to OpenShift first: oc login" && exit 1)
	@echo "ğŸ³ Starting Docker containers and importing TEST data..."
	python3 setup/migration_orchestrator.py auto-setup --env test

# Start Docker containers without data import
docker-start:
	@echo "ğŸ³ Starting Docker containers..."
	@docker compose up -d tfrs
	@echo "ğŸ”„ Starting LCFS environment..."
	@if [ -f "../../docker-compose.yml" ]; then \
		cd ../../ && docker compose up -d; \
	else \
		echo "âš ï¸  LCFS docker-compose.yml not found at ../../docker-compose.yml"; \
		echo "Please start LCFS environment manually"; \
	fi
	@echo "âœ… Docker containers started"
	@make status

# Stop TFRS container
docker-stop:
	@echo "ğŸ›‘ Stopping TFRS container..."
	@docker compose down tfrs
	@echo "âœ… TFRS container stopped"

# Run migrations only (assumes setup complete)
migrate:
	@echo "ğŸš€ Running data migrations..."
	@echo "ğŸ“‹ Checking migration readiness..."
	python3 setup/migration_orchestrator.py check || (echo "âŒ Databases not ready for migration" && exit 1)
	@echo "â–¶ï¸  Running all migration scripts..."
	python3 setup/migration_orchestrator.py migrate

# Run validation only (assumes migration complete)
validate:
	@echo "ğŸ” Running migration validation..."
	python3 setup/migration_orchestrator.py validate

# Check if databases are ready for migration
check:
	@echo "ğŸ” Checking migration readiness..."
	python3 setup/migration_orchestrator.py check

# Show status of containers and databases
status:
	@echo "ğŸ³ Docker Container Status:"
	@echo "=========================="
	@docker ps --format "table {{.ID}}\\t{{.Names}}\\t{{.Status}}\\t{{.Ports}}" | grep -E "(CONTAINER|tfrs|lcfs|postgres)" || echo "No migration containers running"
	@echo ""
	@echo "ğŸ’¾ Database Status:"
	@echo "=================="
	@python3 setup/database_manager.py verify-tfrs 2>/dev/null || echo "TFRS: Not accessible"
	@python3 setup/database_manager.py verify-lcfs 2>/dev/null || echo "LCFS: Not accessible"
	@echo ""
	@echo "ğŸ“Š Migration Readiness:"
	@echo "======================"
	@python3 setup/migration_orchestrator.py check 2>/dev/null && echo "âœ… Ready for migration" || echo "âŒ Not ready for migration"

# Stop all containers
stop:
	@echo "ğŸ›‘ Stopping all migration containers..."
	@docker compose down
	@echo "â„¹ï¸  Note: LCFS environment containers are left running"
	@echo "   To stop LCFS: cd ../../ && docker compose down"

# Clean up everything
clean: stop
	@echo "ğŸ§¹ Cleaning up Docker volumes..."
	@docker compose down -v
	@docker volume prune -f
	@echo "âœ… Cleanup complete"

# Development helpers
install:
	@echo "ğŸ“¦ Installing Python requirements..."
	pip install -r requirements.txt

lint:
	@echo "ğŸ” Running Python linting..."
	@python3 -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "âš ï¸  Linting issues found (not blocking)"

test-docker:
	@echo "ğŸ³ Testing Docker setup..."
	@docker --version
	@docker compose version
	@echo "âœ… Docker is ready"

test-openshift:
	@echo "ğŸ” Testing OpenShift connection..."
	@oc whoami && echo "âœ… OpenShift connection ready" || echo "âŒ Please login: oc login"

# Production data import with extra confirmation
import-prod: 
	@echo "âš ï¸  WARNING: This will import PRODUCTION data to local containers!"
	@echo "ğŸ”’ SECURITY: This is a READ-ONLY operation from production"
	@echo "ğŸ“‹ Production data will OVERWRITE existing local data"
	@read -p "Are you sure you want to proceed? (yes/no): " answer && \
	if [ "$$answer" = "yes" ]; then \
		make setup-prod; \
	else \
		echo "âŒ Production import cancelled"; \
	fi

# Show environment info
info:
	@echo "ğŸ”§ Environment Information:"
	@echo "=========================="
	@echo "Python: $$(python3 --version 2>&1)"
	@echo "Docker: $$(docker --version)"
	@echo "Docker Compose: $$(docker compose version --short 2>/dev/null || docker-compose --version)"
	@echo "OpenShift CLI: $$(oc version --client --short 2>/dev/null || echo 'Not installed')"
	@echo "OpenShift User: $$(oc whoami 2>/dev/null || echo 'Not logged in')"
	@echo ""
	@echo "ğŸ“ Project Structure:"
	@echo "===================="
	@ls -la | grep -E "(core|migrations|setup|validation|docker-compose)"

# Complete workflow examples
workflow-dev:
	@echo "ğŸ”„ Complete DEV workflow..."
	@make setup-dev
	@make migrate  
	@make validate

workflow-prod:
	@echo "ğŸ”„ Complete PRODUCTION workflow..."
	@make import-prod
	@make migrate
	@make validate

# Individual container operations
start-tfrs:
	@echo "ğŸ³ Starting TFRS container only..."
	@docker compose up -d tfrs
	@echo "âœ… TFRS container started"

start-lcfs:
	@echo "ğŸ³ Starting LCFS environment..."
	@if [ -f "../../docker-compose.yml" ]; then \
		cd ../../ && docker compose up -d; \
		echo "âœ… LCFS environment started"; \
	else \
		echo "âŒ LCFS docker-compose.yml not found at ../../docker-compose.yml"; \
	fi

# Database operations
reset-tfrs:
	@echo "ğŸ”„ Resetting TFRS database from existing .tar file..."
	@python3 setup/database_manager.py reset tfrs tfrs_migration

reset-lcfs:
	@echo "ğŸ”„ Resetting LCFS database from existing .tar file..."
	@python3 setup/database_manager.py reset lcfs db
	@echo "ğŸ”§ Running Alembic database migrations..."
	@cd ../../backend && $$(command -v poetry || echo /opt/homebrew/bin/poetry) run alembic upgrade head
	@echo "âœ… Database schema updated to latest version"

reset: reset-lcfs
	@echo "âœ… LCFS database has been reset from the existing dump file"

reset-all: reset-tfrs reset-lcfs
	@echo "âœ… Both TFRS and LCFS databases have been reset from existing dump files"

# Logs
logs-tfrs:
	@echo "ğŸ“‹ TFRS container logs:"
	@docker compose logs tfrs

logs-all:
	@echo "ğŸ“‹ All container logs:"
	@docker compose logs